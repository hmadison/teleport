---
title: Ansible
description: Using Teleport with Ansible
---

Ansible uses the OpenSSH client by default. Teleport supports SSH protocol and
works as SSH jumphost.

In this guide we will configure OpenSSH client to work with Machine ID
and run a sample Ansible playbook.

## Prerequisites

* Installed [Teleport Enterprise](../../enterprise/introduction.mdx) or [Teleport Cloud](../../cloud/introduction.mdx) >= (=teleport.version=)
* `tbot` client tool  >= 9.0.0
* `ssh` OpenSSH tool
* `ansible` >= (=ansible.min_version=)
* Optional tool `jq` to process `JSON` output

## Step 1/3. Start Machine ID

If you already have not done so, follow the
[Machine ID Getting Started Guide](../../docs/pages/machine-id/getting-started.mdx)
to create a bot user and start Machine ID.

If you followed the above guide, you are interested in the
`--destination-dir=/opt/machine-id` flag, which defines the directory where
SSH certificates and OpenSSH configuration used by Ansible will be written to.

In particular, you will be using `/opt/machine-id/ssh_config` in Ansible
configuration to define how Ansible should connect to Teleport nodes.

<Admonition type="tip">
You can edit matching patterns used in `ssh.cfg` if something
is not working out of the box.
</Admonition>

## Step 2/3. Configure Ansible

Create a folder `ansible` where we will collect all generated files:

```code
$ mkdir -p ansible
$ cd ansible
```

Create a file `ansible.cfg`:

```
[defaults]
host_key_checking = True
inventory=./hosts
remote_tmp=/tmp

[ssh_connection]
scp_if_ssh = True
ssh_args = -F /opt/machine-id/ssh_config
```

You can create an inventory file `hosts` manually or use a script like below to
generate it from your environment. Note, `example.com` here is the name of your
Teleport cluster.

```code
$ tsh ls --format=json | jq -r '.[].spec.hostname + ".example.com"' > hosts
```

## Step 3/3. Run a playbook

Finally, let's create a simple Ansible playbook `playbook.yaml`.

The playbook below runs `hostname` on all hosts. Make sure to set the `remote_user` parameter
to a valid SSH username that works with the target host and is allowed by Teleport RBAC.

```yaml
- hosts: all
  remote_user: ubuntu
  tasks:
    - name: "hostname"
      command: "hostname"
```

From the folder `ansible`, run the Ansible playbook:

```code
$ ansible-playbook playbook.yaml 

# PLAY [all] *****************************************************************************************************************************************
# TASK [Gathering Facts] *****************************************************************************************************************************
#
# ok: [terminal]
#
# TASK [hostname] ************************************************************************************************************************************
# changed: [terminal]
#
# PLAY RECAP *****************************************************************************************************************************************
# terminal                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

You are all set. You are now using short-lived SSH certificates and Teleport can now record
all Ansible commands in the audit log.

## Troubleshooting

In case if Ansible can not connect, you may see error like this one:

```txt
example.host | UNREACHABLE! => {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: ssh: Could not resolve hostname node-name: Name or service not known",
    "unreachable": true
}
```

You can examine and tweak patterns matching the inventory hosts in `ssh_config`.

Try the SSH connection using `ssh_config` with verbose mode to inspect the error:

```code
$ ssh -vvv -F /opt/machine-id/ssh_config root@node-name.example.com
```

If `ssh` works, try running the playbook with verbose mode on:

```code
$ ansible-playbook -vvvv playbook.yaml
```
